<div id="tasks-description" class="container-fluid px-0 h-100">
  <div class="row header">
    <div class="task-name">
      Nome
    </div>
    <div class="task-from-date">
      <i class="fa fa-calendar" aria-hidden="true"></i> De
    </div>
    <div class="task-to-date">
      <i class="fa fa-calendar" aria-hidden="true"></i> Até
    </div>
  </div>

  <div class="row header bg-light">
  </div>

  <div cdkDropList (cdkDropListDropped)="dropInside($event)" [cdkDropListData]="projects">

    <div class="scroll-viewport" #scrollViewPort>

      <div class="scroll-viewport-content" [style.margin-top.px]="freeSpaceTop">
        <div *ngFor="let projectKey of projectsKeysDatasource" cdkDrag [cdkDragData]="projectKey">

          <ng-container *ngTemplateOutlet="templateProject; context: {project: projects[projectKey]}"></ng-container>

        </div>
      </div>
    </div>

  </div>

</div>


<!-- templates de função recursiva para percorrer o objeto até ao fim (profundidade desconhecida) -->

<ng-template #templateProject let-project="project">

  <div class="row body">
    <div class="task-name"
         *ngIf="project._hasChildren || project._hasTasks"
         [ngStyle]="project._descriptionStyle">

      <i class="fa fa-chevron-up" aria-hidden="true"
         (click)="toggleCollapseProject(project)" *ngIf="!project.collapsed"></i>
      <i class="fa fa-chevron-down" aria-hidden="true"
         (click)="toggleCollapseProject(project)" *ngIf="project.collapsed"></i> {{project.name}}

    </div>

    <div class="task-name"
         *ngIf="!(project._hasChildren) && !project._hasTasks"
         [ngStyle]="project._descriptionStyle">
      <i class="fa fa-minus" aria-hidden="true"></i> {{project.name}}
    </div>

    <div class="task-from-date">

      <ng-container *ngTemplateOutlet="fromCellTemplate; context: {item: project}"></ng-container>

    </div>

    <div class="task-to-date">

      <ng-container *ngTemplateOutlet="toCellTemplate; context: {item: project}"></ng-container>

    </div>
  </div>

  <ng-template [ngIf]="project._hasTasks && !project.collapsed">
    <div cdkDropList (cdkDropListDropped)="dropInside($event)" [cdkDropListData]="project.tasks">
      <div *ngFor="let task of project.tasks | keyvalue" cdkDrag [cdkDragData]="project.tasks[task.key]">
        <ng-container
          *ngTemplateOutlet="templateTask; context: { task: task.value }"></ng-container>
      </div>
    </div>
  </ng-template>

  <ng-template [ngIf]="project._hasChildren && !project.collapsed">
    <div cdkDropList (cdkDropListDropped)="dropInside($event)" [cdkDropListData]="project.projectChildren">
      <div *ngFor="let proj of project.projectChildren | keyvalue" cdkDrag
           [cdkDragData]="project.projectChildren[proj.key]">
        <ng-container
          *ngTemplateOutlet="templateProject; context: { project: proj.value }"></ng-container>
      </div>
    </div>
  </ng-template>

</ng-template>


<ng-template #templateTask let-task="task" let-index="index">

  <div class="row body">
    <div class="task-name"
         [ngStyle]="task._descriptionStyle">
      {{task.name}}
    </div>
    <div class="task-from-date">

      <ng-container *ngTemplateOutlet="fromCellTemplate; context: {item: task}"></ng-container>

    </div>

    <div class="task-to-date">
      <ng-container *ngTemplateOutlet="toCellTemplate; context: {item: task}"></ng-container>
    </div>
  </div>

</ng-template>

<!--template dos date e time picker da data 'from' -->
<ng-template #fromCellTemplate let-item="item">
  <ng-template #popFromDateTitle>
    <div class="container text-right px-0">
      <i class="fa fa-times" aria-hidden="true" (click)="dateFromPickerPopover.close()"></i>
    </div>
  </ng-template>

  <ng-template #popFromDateContent>

    <mat-form-field class="date-picker">
      <input matInput
             (dateInput)="fromDateChanged($event, item)"
             [matDatepicker]="fromDatePicker"
             [ngModel]="item.date.from">
      <mat-datepicker-toggle matSuffix [for]="fromDatePicker"></mat-datepicker-toggle>
      <mat-datepicker #fromDatePicker></mat-datepicker>
    </mat-form-field>

  </ng-template>

  <ng-template #popFromTimeTitle>
    <div class="container text-right px-0">
      <i class="fa fa-times" aria-hidden="true" (click)="timeFromPickerPopover.close()"></i>
    </div>
  </ng-template>

  <ng-template #popFromTimeContent>
    <ngb-timepicker size="small" [ngModel]="item.date.from" (ngModelChange)="fromTimeChanged($event, item)"></ngb-timepicker>
  </ng-template>

  <button
    type="button"
    class="btn btn-outline-secondary"
    #dateFromPickerPopover="ngbPopover"
    [disablePopover]="!datePickerActive"
    [autoClose]="false"
    triggers="manual"
    (click)="dateFromPickerPopover.toggle()"
    [popoverTitle]="popFromDateTitle"
    [ngbPopover]="popFromDateContent">
    {{ item.date.from | date: 'd MMM yyyy' }}
  </button>

  <button
    type="button"
    class="btn btn-outline-secondary"
    #timeFromPickerPopover="ngbPopover"
    [disablePopover]="!timePickerActive"
    [autoClose]="false"
    triggers="manual"
    (click)="timeFromPickerPopover.toggle()"
    [popoverTitle]="popFromTimeTitle"
    [ngbPopover]="popFromTimeContent">
    {{ item.date.from | date: 'HH:mm' }}
  </button>
</ng-template>

<!--template dos date e time picker da data 'to'-->
<ng-template #toCellTemplate let-item="item">
  <ng-template #popToDateTitle>
    <div class="container text-right px-0">
      <i class="fa fa-times" aria-hidden="true" (click)="dateToPickerPopover.close()"></i>
    </div>
  </ng-template>

  <ng-template #popToDateContent>

    <mat-form-field class="date-picker">
      <input matInput
             (dateInput)="toDateChanged($event, item)"
             [matDatepicker]="toDatePicker"
             [ngModel]="item.date.to">
      <mat-datepicker-toggle matSuffix [for]="toDatePicker"></mat-datepicker-toggle>
      <mat-datepicker #toDatePicker></mat-datepicker>
    </mat-form-field>

  </ng-template>

  <ng-template #popToTimeTitle>
    <div class="container text-right px-0">
      <i class="fa fa-times" aria-hidden="true" (click)="timeToPickerPopover.close()"></i>
    </div>
  </ng-template>

  <ng-template #popToTimeContent>

    <ngb-timepicker size="small" [ngModel]="item.date.to" (ngModelChange)="toTimeChanged($event, item)"></ngb-timepicker>

  </ng-template>

  <button
    type="button"
    class="btn btn-outline-secondary"
    #dateToPickerPopover="ngbPopover"
    [disablePopover]="!datePickerActive"
    [autoClose]="false"
    triggers="manual"
    (click)="dateToPickerPopover.toggle()"
    [popoverTitle]="popToDateTitle"
    [ngbPopover]="popToDateContent">
    {{ item.date.to | date: 'd MMM yyyy' }}
  </button>

  <button
    type="button"
    class="btn btn-outline-secondary"
    #timeToPickerPopover="ngbPopover"
    [disablePopover]="!timePickerActive"
    [autoClose]="false"
    triggers="manual"
    (click)="timeToPickerPopover.toggle()"
    [popoverTitle]="popToTimeTitle"
    [ngbPopover]="popToTimeContent">
    {{ item.date.to | date: 'HH:mm' }}
  </button>
</ng-template>
