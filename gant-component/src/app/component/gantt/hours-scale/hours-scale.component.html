<div id="tasks-content" class="container-fluid h-100 px-0">
  <div id="background-content" #horizontalScrollViewPort class="container-fluid h-100 px-0">

    <div id="background-layer" class="container-fluid px-0"
         [style.width.px]="dateCellWidth * totalDateRange.length"
         [style.margin-left.px]="scrollFreeSpaceLeft">

      <ng-template ngFor let-date [ngForOf]="totalDateRange">
        <div class="date-container" [style.width.px]="dateCellWidth">
          <div class="date-cell text-center bg-light" [style.width.px]="dateCellWidth">{{date | date}}</div>
          <div class="hours-cell text-center bg-light" *ngFor="let hour of scaleRange"
               [style.width.px]="elmtCellWidth">{{hour | date: 'HH:mm'}}</div>
        </div>
      </ng-template>

      <div class="background-tasks-container" #verticalScrollViewPort>

        <div class="background-tasks-content" [style.margin-top.px]="freeSpaceTop">
          <ng-template ngFor let-projKey [ngForOf]="projectsKeysDatasource">
            <ng-container *ngTemplateOutlet="rowProjectTemplate; context: {item: projects[projKey]}"></ng-container>
          </ng-template>
        </div>
      </div>

    </div>


  </div>

  <div id="projects-layer" class="container-fluid px-0">

    <div class="projects-layer-content">

      <ng-template ngFor let-projKey [ngForOf]="projectsKeysDatasource">
        <ng-container *ngTemplateOutlet="projectTemplate; context: {item: projects[projKey]}"></ng-container>
      </ng-template>

    </div>

  </div>
</div>

<!--==================================================================-->

<ng-template #rowProjectTemplate let-item="item">
  <div class="row mx-0">
    <ng-template ngFor let-date [ngForOf]="totalDateRange">

      <div class="elmt-cell" *ngFor="let hour of scaleRange"
           [style.width.px]="elmtCellWidth"></div>

    </ng-template>
  </div>

  <ng-template [ngIf]="item._hasTasks && !item.collapsed">
    <ng-container *ngTemplateOutlet="rowTaskTemplate; context: {tasks: item.tasks}"></ng-container>
  </ng-template>

  <ng-template [ngIf]="item._hasChildren && !item.collapsed">
    <ng-template ngFor let-proj [ngForOf]="item.projectChildren | keyvalue">
      <ng-container *ngTemplateOutlet="rowProjectTemplate; context: {item: proj.value}"></ng-container>
    </ng-template>
  </ng-template>

</ng-template>

<ng-template #rowTaskTemplate let-tasks="tasks">
  <div class="row mx-0" *ngFor="let task of tasks | keyvalue">
    <ng-template ngFor let-date [ngForOf]="totalDateRange">

      <div class="elmt-cell" *ngFor="let hour of scaleRange"
           [style.width.px]="elmtCellWidth"></div>

    </ng-template>
  </div>
</ng-template>

<!--==================================================================-->

<ng-template #projectTemplate let-item="item">
  <div class="project-cell"
       *ngIf="item._detailsStyle['width'] !== '0px'"
       [ngStyle]="item._detailsStyle"
       [style.left.px]="-verticalScrollPositionX"
       [style.top.px]="-verticalScrollPositionY">{{item.name}}</div>

  <ng-template [ngIf]="item._hasTasks && !item.collapsed">
    <ng-container *ngTemplateOutlet="taskTemplate; context: {tasks: item.tasks}"></ng-container>
  </ng-template>

  <ng-template [ngIf]="item._hasChildren && !item.collapsed">
    <ng-template ngFor let-proj [ngForOf]="item.projectChildren | keyvalue">
      <ng-container *ngTemplateOutlet="projectTemplate; context: {item: proj.value}"></ng-container>
    </ng-template>
  </ng-template>
</ng-template>

<ng-template #taskTemplate let-tasks="tasks">
  <ng-template ngFor let-task [ngForOf]="tasks | keyvalue">
    <div class="project-cell"
         *ngIf="task.value._detailsStyle['width'] !== '0px'"
         [ngStyle]="task.value._detailsStyle"
         [style.left.px]="-verticalScrollPositionX"
         [style.top.px]="-verticalScrollPositionY">{{task.value.name}}</div>
  </ng-template>
</ng-template>
